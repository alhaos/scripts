$hash = @{'\990 ' = 'Presumptive Positive'; '\989 ' = 'Invalid'; '\61 ' = 'QNS'; '\61    @' = 'QNS'; 'QNS' = 'QNS'; 'INVALID ' = 'Invalid'; 'INVALID' = 'Invalid'; 'LOWPOS ' = 'Inconclusive';'LOWPOS' = 'Inconclusive'; 'POSITIVE' = 'Positive'; 'NEGATIVE' = 'Negative'}
$in = Import-Csv (Get-ChildItem -Path D:\Comtron\Archive\*.csv | where-object {$_.LastWriteTime -gt (get-date).AddMinutes(-240)}).FullName -Delimiter "`t" | ? "Client ID" -in "39354" | ? "Test Code" -in "Z620","Z630","620Z" | ? "Test Result" -in $hash.keys | Sort-Object "Accession","Final Report Date" -Unique | Where "Final Report Date" -ne '' | Select-Object *,@{n="VoucherNo";Expression={$_.'OrderNumber'.trim()}},@{n="FirstName";Expression={$_.'First Name'.trim()}},@{n="LastName";Expression={$_.'Last Name'.trim()}},@{n="DateOfBirth";Expression={get-date $_.'DOB' -f 'yyyyMMdd'}},@{n="LabName";Expression={$_.'LabName'}},@{n="CollectedDate";Expression={get-date $_.'Collection Date' -f 'yyyyMMdd'}},@{n="ReceivedDate";Expression={get-date $_.'Entry Date' -f 'yyyyMMdd'}},@{n="ReportedDate";Expression={get-date $_.'Final Report Date' -f 'yyyyMMdd'}},@{n="Result";Expression={$_.'Test Result'}},@{n="LabReference";Expression={$_.'Accession'}} -Exclude 'OrderNumber','First Name','Last Name','DOB','Collection Date','Entry Date','Final Report Date','Test Result','Accession' | Select-Object -Property VoucherNo,FirstName,LastName,DateOfBirth,Gender,@{n="LabName";e={"ACCU"}},CollectedDate,ReceivedDate,ReportedDate,Result,LabReference
foreach ($row in $in | Where Result -in $hash.keys) {$row.Result = $hash[$row.Result]}
$pcomp = 'LabReference'
$in2 = Import-Csv (Get-ChildItem -Path D:\Comtron\Archive\ReP\Acct\39354\*.csv).FullName
$dup = Compare-Object $in $in2 -Property $pcomp -IncludeEqual -ExcludeDifferent -PassThru | Select-Object -ExpandProperty $pcomp
$res = $in | Where-Object {$_.$pcomp -notin $dup}
if ($res) {$res | Sort-Object "LabReference" | Export-Csv "D:\Comtron\Archive\ReP\Acct\39354\ImpactHealth_ACCU_Results_$((Get-Date).ToString("yyyyMMddHHmm")).csv" -NoTypeInformation -UseQuotes AsNeeded
$res | Sort-Object "LabReference" | Export-Csv "D:\FTP\ImpactHealth\Results\ImpactHealth_ACCU_Results_$((Get-Date).ToString("yyyyMMddHHmm")).csv" -NoTypeInformation -UseQuotes AsNeeded}